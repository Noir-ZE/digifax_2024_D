# 问题二解答：代码模块实施计划

本计划旨在将问题二的解题方案分解为一系列可执行、可管理的编码任务。整个工作流程分为准备阶段和四个核心代码模块。

## 一、 准备工作 (Preparations)

在开始编码前，请确保完成以下准备：

1.  **环境配置**:
    - 安装 Python (推荐 3.8+)。
    - 创建虚拟环境并安装核心库:
      ```bash
      pip install geopandas rasterio rioxarray xarray pandas numpy scikit-learn statsmodels mgwr matplotlib mapclassify pmdarima
      ```
2.  **数据整理**:
    - 下载并解压所有数据集。
    - 建立清晰的工程目录结构：
      ```
      project_root/
      ├── data_raw/
      ├── data_processed/
      ├── scripts/
      ├── results/
      │   ├── figures/
      │   └── tables/
      └── ...
      ```
3.  **数据熟悉**:
    - 使用 QGIS 或 Python 快速预览各数据集，重点关注其内容、坐标参考系统 (CRS) 和数据范围。

---

## 二、 代码模块划分

### 模块1: `01_data_preprocessing.py` - 数据预处理与特征工程

**目标**: 将所有来源不同、格式各异的原始数据，处理并统一为一张可直接用于建模的 `GeoDataFrame` 表。

- 1 **定义常量**: 设定文件路径、分析时段 (1990-2020) 和基准网格 (0.25°)。
- 2 **处理降水数据 (数据集3)**:
    - [ ] 读取 NetCDF 文件，筛选时间范围。
    - [ ] 计算因变量 $Y_1$ (暴雨发生概率) 和 $Y_2$ (暴雨强度)。
    - [ ] 计算自变量 $X_6$ (年均总降水量)。
- 3 **处理气温数据 (数据集2)**:
    - [ ] 计算1990-2018年夏季均温。
    - [ ] 使用 `auto_arima` 预测2019-2020年夏季均温。
    - [ ] 计算自变量 $X_5$ (1990-2020年夏季平均气温)。
    - [ ] 将结果重采样至0.25°基准网格。
- 4 **处理地形数据 (数据集1)**:
    - [ ] 读取1km DEM数据。
    - [ ] 聚合计算0.25°网格内的 $X_1$ (平均高程) 和 $X_2$ (地形起伏度)。
    - [ ] 在1km分辨率下计算坡度，再聚合得到 $X_3$ (平均坡度)。
- 5 **处理土地利用数据 (数据集4)**:
    - [ ] 读取2019年土地利用数据。
    - [ ] 聚合计算0.25°网格内的 $X_7$ (林地覆盖率) 和 $X_8$ (水体/湿地覆盖率)。
- 6 **合并与保存**:
    - [ ] 将所有变量 (Y1, Y2, X1-X8) 合并为一个 `GeoDataFrame`。
    - [ ] 处理可能存在的缺失值。
    - [ ] 将最终的干净数据保存为 `data_processed/analysis_data.gpkg`。

---

### 模块2: `02_exploratory_data_analysis.py` - 探索性数据分析

**目标**: 通过可视化手段，深入理解各变量的空间分布特征和相互关系。

- 1 加载 `analysis_data.gpkg`。
- 2 **空间分布图**: 为所有因变量和自变量绘制全国范围的填色图。
- 3 **相关性分析**: 计算各变量间的相关系数矩阵，并用热力图可视化，初步检查多重共线性。
- 4 **保存图表**: 将所有生成的图表清晰地保存至 `results/figures/` 目录。

---

### 模块3: `03_modeling_and_analysis.py` - 核心建模与分析

**目标**: 执行两阶段模型（Logistic回归和GWR），并保存模型结果以供分析。

- 1 加载 `analysis_data.gpkg`。
- 2 **阶段一: Logistic 回归**:
    - [ ] 数据标准化。
    - [ ] 使用 `statsmodels.Logit` 拟合模型 `Y1 ~ X1 + ... + X8`。
    - [ ] 将模型摘要（系数、p值等）保存到 `results/tables/logistic_results.csv`。
- 3 **阶段二: 地理加权回归 (GWR)**:
    - [ ] 筛选出 $Y_2$ 有效的样本数据。
    - [ ] **带宽选择**: 使用 `mgwr.sel_bw.Sel_BW` 寻找最优带宽。
    - [ ] **模型拟合**: 使用 `mgwr.gwr.GWR` 拟合模型 `Y2 ~ X1 + ... + X8`。
    - [ ] 将GWR结果（局部系数、局部R²等）合并回 `GeoDataFrame`，并保存为 `results/gwr_results.gpkg`。

---

### 模块4: `04_results_visualization.py` - 模型结果可视化

**目标**: 将复杂的模型结果转化为直观、有力的图表，用于最终的论文报告。

- 1 加载 `gwr_results.gpkg`。
- 2 **绘制GWR系数图**: 为关键变量（如坡度、高程、气温）的局部回归系数绘制空间分布图。
- 3 **绘制模型诊断图**: 绘制GWR模型的局部R²空间分布图，评估模型拟合效果的空间差异。
- 4 **图表美化**: 精心设计图例、配色和地图元素。
- 5 **保存最终图表**: 将所有用于报告的核心图表以高分辨率格式保存至 `results/figures/` 目录。